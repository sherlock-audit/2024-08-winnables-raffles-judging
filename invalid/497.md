Lone Peanut Swallow

High

# Winners participating with a Safe wallet can have their prize stolen under certain conditions

## Summary

Given that Safe wallets are deployed by [Safe's ProxyFactory](https://snowtrace.io/address/0xC22834581EbC8527d974F8a1c97E1bEA4EF910BC/contract/43114/code), and that such deployments are chain independent, users that enter a raffle using a Safe on Avalanche are not guaranteed to be the end receivers of the prize on Ethereum.

## Vulnerability Detail

The protocol bears the core assumption that users on Avalanche have access to the same account on Ethereum. 
This can be found by analyzing the payload of the CCIP message sent from Avalanche's [`WinnablesTicketManager.sol`](https://github.com/sherlock-audit/2024-08-winnables-raffles/blob/main/public-contracts/contracts/WinnablesTicketManager.sol) to Ethereum's [`WinnablesPrizeManager.sol`](https://github.com/sherlock-audit/2024-08-winnables-raffles/blob/main/public-contracts/contracts/WinnablesPrizeManager.sol) : the [`WinnablesTicketManager.propagateRaffleWinner`](https://github.com/sherlock-audit/2024-08-winnables-raffles/blob/main/public-contracts/contracts/WinnablesTicketManager.sol#L334) method computes the winner of a given raffle leveraging the [`WinnablesTicketManager._getWinnerByRequestId`](https://github.com/sherlock-audit/2024-08-winnables-raffles/blob/main/public-contracts/contracts/WinnablesTicketManager.sol#L472-L477) internal method. Such method computes and returns the owner of the winning ticket's ID. 
Once the winner has been computed, the `WinnablesTicketManager.propagateRaffleWinner` then dispatches a CCIP message containing the raffle's winner to `WinnablesPrizeManager.sol` on Ethereum, which is ultimately captured by the [`WinnablesPrizeManager._ccipReceive`](https://github.com/sherlock-audit/2024-08-winnables-raffles/blob/main/public-contracts/contracts/WinnablesPrizeManager.sol#L260) internal method.
Upon receiving a `WINNER_DRAWN` message, the `WinnablesPrizeManager.sol` contract decodes the incoming CCIP message's payload as is and sets the raffle winner to the received address.
Only the winner of the raffle is thus able to claim his prize by calling [`WinnablesPrizeManager.claimPrize`](https://github.com/sherlock-audit/2024-08-winnables-raffles/blob/main/public-contracts/contracts/WinnablesPrizeManager.sol#L105), providing it with the correct raffle ID.

The protocol also allows smart contracts to buy tickets and participate in raffles, as can be understood by examining the [`WinnablesTicket.mint`](https://github.com/sherlock-audit/2024-08-winnables-raffles/blob/main/public-contracts/contracts/WinnablesTicket.sol#L182-L199) function, which executes an [acceptance check](https://github.com/sherlock-audit/2024-08-winnables-raffles/blob/main/public-contracts/contracts/WinnablesTicket.sol#L218-L234) on the receiver of the newly minted tickets in the case in which the recipient is found to be an account with code. As such, Safe wallets are fully supported by the protocol, given that they [support ERC1155 assets](https://help.safe.global/en/articles/40825-supported-asset-types).

Observing this, in the scenario in which:
1. The winner of a given raffle participated by using a Safe wallet, and
2. The Safe wallet used by the user on Avalanche has **not yet been created on Ethereum**.

An attacker is able to rush to deploy instances of Safe wallets on Ethereum, until he is able to mint the Safe whose address matches that of the winner on Avalanche. By doing so, the attacker will become the owner of a Safe wallet deployed at the raffle's winner address, effectively gaining the ability to claim the raffle's prize via his Safe.

In particular, notice that:
1. In case Avalanche's `ProxyFactory`'s nonce is higher than Ethereum's, the attacker is able to create the necessary conditions to meet condition 2. by deploying a large number of Safe wallets himself.
2. Given the asynchronous nature of the winner transmission, an attacker disposes of an amount of time (equal to the time it takes the CCIP infrastructure to deposit the message propagating the raffle winner) in which he can spam Safe deployments to reach the victim wallet's nonce. Such deployments can occur at a pace of 160 contracts per Ethereum transaction, as is shown in the reference posted below.
3. Given that the code deployed at [Avalanche's ProxyFactory](https://snowtrace.io/address/0xC22834581EbC8527d974F8a1c97E1bEA4EF910BC/contract/) matches the one deployed on the [same account on Ethereum](https://etherscan.io/address/0xC22834581EbC8527d974F8a1c97E1bEA4EF910BC#code), the same chain of Safe wallets can be generated by anyone.

As a result, after the attacker has successfully deployed a Safe wallet under his possession to the raffle winner's address, he can steal the prize by simply calling `WinnablesPrizeManager.claimPrize`.

For reference of the exploitability of this exact attack vector, see how it was leveraged to [steal 20M OP tokens from Wintermute](https://inspexco.medium.com/how-20-million-op-was-stolen-from-the-multisig-wallet-not-yet-owned-by-wintermute-3f6c75db740a).

## Impact

High.
Under particular conditions, an attacker is able to steal the prize won by a user who participated in a raffle using a Safe wallet.

## Code Snippet

- `WinnablesTicket.sol`
    - [`mint`](https://github.com/sherlock-audit/2024-08-winnables-raffles/blob/main/public-contracts/contracts/WinnablesTicket.sol#L182)
    - [`_doSafeTransferAcceptanceCheck`](https://github.com/sherlock-audit/2024-08-winnables-raffles/blob/main/public-contracts/contracts/WinnablesTicket.sol#L218)
- `WinnablesTicketManager.sol`
    -  [`buyTickets`](https://github.com/sherlock-audit/2024-08-winnables-raffles/blob/main/public-contracts/contracts/WinnablesTicketManager.sol#L182)
    - [`propagateRaffleWinner`](https://github.com/sherlock-audit/2024-08-winnables-raffles/blob/main/public-contracts/contracts/WinnablesTicketManager.sol#L334)
    - [`_getWinnerByRequetId`](https://github.com/sherlock-audit/2024-08-winnables-raffles/blob/main/public-contracts/contracts/WinnablesTicketManager.sol#L472)
- `WinnablesPrizeManager.sol`
    - [`claimPrize`](https://github.com/sherlock-audit/2024-08-winnables-raffles/blob/main/public-contracts/contracts/WinnablesPrizeManager.sol#L105)
    - [`_ccipReceive`](https://github.com/sherlock-audit/2024-08-winnables-raffles/blob/main/public-contracts/contracts/WinnablesPrizeManager.sol#L260)

## PoC

Following is a step-wise PoC showing how an attacker can steal the prize from users, who have deployed a Safe wallet through the Factory's route that leverages `CREATE2`, which is the most popular way to do so on Avalanche at the time of writing.
A similar, although longer, PoC can be made for Safes deployed using `CREATE`.

0. Assume that victims Alice and Bob have deployed a 2 of 2 multisig Safe wallet on Avalanche, whose address is `0xCC..CC`. They've done so by calling `ProxyFactory.deployProxyWithNonce`, providing a custom salt `0x012345`. Assume also that Alice and Bob have taken part in the latest Winnables raffle via their Safe and have been selected as the winners.
1. As soon as the winner is drawn, Charlie notices that `0xCC..CC` is an empty account on Ethereum.
2. Charlie rushes to call `ProxyFactory.deployProxyWithNonce`, providing `0x012345` as the salt, on the Ethereum instance of `ProxyFactory`. As per `CREATE2` functionality, the created Safe wallet is assigned to address `0xCC..CC`.
3. CCIP infrastructure has processed and correctly delivered the Winnables message which propagates the raffle winner, address `0xCC..CC`, to Ethereum.
4. `WinnablesPrizeManager` registers the received address as the winner of the latest raffle.
5. Charlie is now able to steal Alice's and Bob's prize by routing a call to `WinnablesPrizeManager.claimPrize` via his Safe wallet.

## Tool used

Manual Review

## Recommendation

The system should allow for raffle ticket buyers to optionally specify a different address to which they wish to receive the prize on Ethereum. 
Such functionality could be implemented via a `mapping(address => address)`, whose content is only used to overwrite the recipient of a raffle prize if the value associated to the winning ticket's owner is different from `address(0)`.